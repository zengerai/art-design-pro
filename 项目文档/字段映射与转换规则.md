# 字段映射与转换规则文档

> **文档版本**: v1.0  
> **创建时间**: 2024-11-16  
> **适用范围**: 用户管理、角色管理模块  
> **维护状态**: 🟢 活跃维护中

---

## 📖 文档说明

本文档详细记录了前端、后端、数据库三层之间的字段映射关系和数据转换规则，确保团队成员能够快速理解数据流转过程。

### 文档结构

1. [用户管理模块](#一用户管理模块)
2. [角色管理模块](#二角色管理模块)
3. [通用转换规则](#三通用转换规则)
4. [数据库迁移记录](#四数据库迁移记录)
5. [快速查询索引](#五快速查询索引)

---

## 一、用户管理模块

### 1.1 用户列表查询

#### 完整映射表

| 前端字段 | 前端类型 | 后端API字段 | 后端类型 | 数据库字段 | 数据库类型 | 转换规则 | 说明 |
| --- | --- | --- | --- | --- | --- | --- | --- |
| id | number | id | number | id | INT | 无 | 用户ID |
| userName | string | userName | string | username | VARCHAR(50) | 无 | 用户名 |
| nickName | string | nickName | string | nickname | VARCHAR(50) | 无 | 昵称 |
| avatar | string | avatar | string | avatar | VARCHAR(255) | 无 | 头像URL |
| userGender | string | userGender | string | sex | TINYINT | 1→"1", 2→"2" | 性别（显示时需转为"男"/"女"） |
| userPhone | string | userPhone | string | mobile | VARCHAR(20) | 无 | 手机号 |
| userEmail | string | userEmail | string | email | VARCHAR(100) | 无 | 邮箱 |
| status | string | status | number | status | TINYINT | 1→"1", 0→"0" | 启用状态 |
| userRoles | string[] | userRoles | string | role_code | VARCHAR(50) | 转为数组 | 角色编码（通过JOIN查询） |
| createTime | string | createTime | string | created_at | DATETIME | 格式化为字符串 | 创建时间 |
| updateTime | string | updateTime | string | updated_at | DATETIME | 格式化为字符串 | 更新时间 |

#### SQL查询示例

```sql
SELECT
  u.id,
  u.username as userName,
  u.nickname as nickName,
  u.avatar,
  u.sex as userGender,
  u.mobile as userPhone,
  u.email as userEmail,
  u.status,
  u.created_at as createTime,
  u.updated_at as updateTime,
  r.role_code as userRoles
FROM users u
LEFT JOIN roles r ON u.role_id = r.id
WHERE 1=1
  -- 条件筛选...
```

#### 后端数据处理

```typescript
// 将 userRoles 转为数组
records.map((r) => ({
  ...r,
  userRoles: r.userRoles ? [r.userRoles] : []
}))
```

#### 前端显示转换

```typescript
// 性别显示转换
const genderMap = { '1': '男', '2': '女' }
const displayGender = genderMap[userGender] || '未知'

// 状态显示转换
const statusMap = { '1': '启用', '0': '禁用' }
const displayStatus = statusMap[status] || '未知'
```

---

### 1.2 用户创建

#### 完整映射表

| 前端表单字段 | 前端类型 | API参数字段 | API类型 | 后端接收字段 | 数据库字段 | 数据库类型 | 转换规则 | 说明 |
| --- | --- | --- | --- | --- | --- | --- | --- | --- |
| username | string | username | string | username | username | VARCHAR(50) | 无 | 用户名 |
| phone | string | phone | string | phone → mobile | mobile | VARCHAR(20) | 字段名映射 | 手机号 |
| gender | "男"\|"女" | gender | string | gender → sex | sex | TINYINT | "男"→1, "女"→2 | 性别 |
| role | string[] | role | string[] | role → role_id | role_id | INT | 查询roles表转换 | 角色（取数组第一个元素） |
| - | - | - | - | password | password | VARCHAR(255) | bcrypt('123456') | 密码（固定默认值） |
| - | - | - | - | status | status | TINYINT | 固定为1 | 启用状态 |
| - | - | - | - | create_by | create_by | INT | JWT Token userId | 创建人ID |
| - | - | - | - | update_by | update_by | INT | JWT Token userId | 更新人ID |
| - | - | - | - | created_at | created_at | DATETIME | NOW() | 创建时间 |

#### SQL插入示例

```sql
INSERT INTO users (
  username,
  password,
  mobile,
  sex,
  role_id,
  status,
  create_by,
  update_by,
  created_at,
  updated_at
) VALUES (?, ?, ?, ?, ?, 1, ?, ?, NOW(), NOW())
```

#### 后端转换逻辑

```typescript
// 性别转换
const sexValue = gender === '男' ? 1 : 2

// 角色转换（从角色编码查询角色ID）
const [roleRows] = await pool.execute('SELECT id FROM roles WHERE role_code = ?', [role[0]])
const roleId = roleRows[0]?.id || 3 // 默认为普通用户

// 创建人/更新人（从JWT Token获取）
const userId = req.user?.userId
```

---

### 1.3 用户更新

#### 完整映射表

| 前端表单字段 | 前端类型 | API参数字段 | API类型 | 后端接收字段 | 数据库字段 | 数据库类型 | 转换规则 | 说明 |
| --- | --- | --- | --- | --- | --- | --- | --- | --- |
| username | string | username | string | username | username | VARCHAR(50) | 无 | 用户名 |
| phone | string | phone | string | phone → mobile | mobile | VARCHAR(20) | 字段名映射 | 手机号 |
| gender | "男"\|"女" | gender | string | gender → sex | sex | TINYINT | "男"→1, "女"→2 | 性别 |
| role | string[] | role | string[] | role → role_id | role_id | INT | 查询roles表转换（可选） | 角色 |
| - | - | - | - | update_by | update_by | INT | JWT Token userId | 更新人ID |
| - | - | - | - | updated_at | updated_at | DATETIME | NOW() | 更新时间 |

#### SQL更新示例

```sql
UPDATE users SET
  username = ?,
  mobile = ?,
  sex = ?,
  role_id = ?, -- 如果提供
  update_by = ?,
  updated_at = NOW()
WHERE id = ?
```

---

### 1.4 字段值转换规则

#### 性别字段转换

| 前端显示 | 前端表单 | API传输 | 后端处理 | 数据库存储 | 查询返回    |
| -------- | -------- | ------- | -------- | ---------- | ----------- |
| "男"     | "男"     | "男"    | 转换→1   | 1          | "1"(字符串) |
| "女"     | "女"     | "女"    | 转换→2   | 2          | "2"(字符串) |

**转换代码**：

```typescript
// 创建/更新时：前端 → 数据库
const sex = gender === '男' ? 1 : 2

// 查询时：数据库 → 前端显示
const genderMap = { '1': '男', '2': '女' }
const displayGender = genderMap[userGender]
```

#### 角色字段转换

| 前端显示       | 前端表单    | API传输     | 后端处理 | 数据库存储 | 查询返回  |
| -------------- | ----------- | ----------- | -------- | ---------- | --------- |
| ["超级管理员"] | ["R_SUPER"] | ["R_SUPER"] | 查询→1   | 1          | "R_SUPER" |
| ["管理员"]     | ["R_ADMIN"] | ["R_ADMIN"] | 查询→2   | 2          | "R_ADMIN" |
| ["普通用户"]   | ["R_USER"]  | ["R_USER"]  | 查询→3   | 3          | "R_USER"  |

**转换代码**：

```typescript
// 创建/更新时：角色编码 → 角色ID
const [roleRows] = await pool.execute('SELECT id FROM roles WHERE role_code = ?', [role[0]])
const roleId = roleRows[0]?.id || 3

// 查询时：JOIN查询获取role_code，转为数组
userRoles: r.userRoles ? [r.userRoles] : []
```

#### 审计字段自动填充

| 字段名     | 创建时   | 更新时   | 数据来源            |
| ---------- | -------- | -------- | ------------------- |
| create_by  | ✅ 填充  | ❌ 不变  | JWT Token中的userId |
| update_by  | ✅ 填充  | ✅ 更新  | JWT Token中的userId |
| created_at | ✅ NOW() | ❌ 不变  | 数据库时间戳        |
| updated_at | ✅ NOW() | ✅ NOW() | 数据库时间戳        |

**转换代码**：

```typescript
// 从JWT Token获取当前用户ID
const userId = req.user?.userId || 0

// 插入时
create_by: userId,
update_by: userId

// 更新时
update_by: userId
```

---

## 二、角色管理模块

### 2.1 角色列表查询

#### 完整映射表

| 前端字段 | 前端类型 | 后端API字段 | 后端类型 | 数据库字段 | 数据库类型 | 转换规则 | 说明 |
| --- | --- | --- | --- | --- | --- | --- | --- |
| roleId | number | roleId | number | id | INT | 无 | 角色ID |
| roleName | string | roleName | string | role_name | VARCHAR(50) | 无 | 角色名称 |
| roleCode | string | roleCode | string | role_code | VARCHAR(50) | 无 | 角色编码 |
| description | string | description | string | description | VARCHAR(200) | 无 | 角色描述 |
| enabled | boolean | enabled | boolean | enabled | TINYINT | 1→true, 0→false | 启用状态 |
| createTime | string | createTime | string | created_at | DATETIME | 格式化为字符串 | 创建时间 |
| updateTime | string | updateTime | string | updated_at | DATETIME | 格式化为字符串 | 更新时间 |

#### SQL查询示例

```sql
SELECT
  id as roleId,
  role_name as roleName,
  role_code as roleCode,
  description,
  enabled,
  created_at as createTime,
  updated_at as updateTime
FROM roles
WHERE 1=1
  -- 条件筛选...
```

#### 后端数据处理

```typescript
// 将数据库的 TINYINT(0/1) 转换为 boolean
records.map((r) => ({
  ...r,
  enabled: r.enabled === 1
}))
```

---

### 2.2 角色创建

#### 完整映射表

| 前端表单字段 | 前端类型 | API参数字段 | API类型 | 后端接收字段 | 数据库字段 | 数据库类型 | 转换规则 | 说明 |
| --- | --- | --- | --- | --- | --- | --- | --- | --- |
| roleName | string | roleName | string | roleName | role_name | VARCHAR(50) | 无 | 角色名称 |
| roleCode | string | roleCode | string | roleCode | role_code | VARCHAR(50) | 无 | 角色编码 |
| description | string | description | string | description | description | VARCHAR(200) | 无 | 角色描述 |
| enabled | boolean | enabled | boolean | enabled → status | enabled | TINYINT | true→1, false→0 | 启用状态 |
| dashboardPath | string | dashboardPath | string | dashboardPath | dashboard_path | VARCHAR(200) | 默认值处理 | 控制台路径 |
| - | - | - | - | - | created_at | DATETIME | NOW() | 创建时间 |

#### SQL插入示例

```sql
INSERT INTO roles (
  role_name,
  role_code,
  dashboard_path,
  description,
  enabled,
  created_at
) VALUES (?, ?, ?, ?, ?, NOW())
```

#### 后端转换逻辑

```typescript
// 启用状态转换
const statusValue = enabled ? 1 : 0

// 控制台路径（可选，默认值）
const dashboardPathValue = dashboardPath || '/user/dashboard/console'
```

---

### 2.3 角色更新

#### 完整映射表

| 前端表单字段 | 前端类型 | API参数字段 | API类型 | 后端接收字段 | 数据库字段 | 数据库类型 | 转换规则 | 说明 |
| --- | --- | --- | --- | --- | --- | --- | --- | --- |
| roleName | string | roleName | string | roleName | role_name | VARCHAR(50) | 无 | 角色名称 |
| roleCode | string | roleCode | string | roleCode | role_code | VARCHAR(50) | 无 | 角色编码 |
| description | string | description | string | description | description | VARCHAR(200) | 无 | 角色描述 |
| enabled | boolean | enabled | boolean | enabled → status | enabled | TINYINT | true→1, false→0 | 启用状态 |
| dashboardPath | string | dashboardPath | string | dashboardPath | dashboard_path | VARCHAR(200) | 可选更新 | 控制台路径（可选） |
| - | - | - | - | - | updated_at | DATETIME | NOW() | 更新时间 |

#### SQL更新示例

```sql
-- 基础更新（不包含 dashboardPath）
UPDATE roles SET
  role_name = ?,
  role_code = ?,
  description = ?,
  enabled = ?,
  updated_at = NOW()
WHERE id = ?

-- 包含 dashboardPath 的更新
UPDATE roles SET
  role_name = ?,
  role_code = ?,
  description = ?,
  enabled = ?,
  dashboard_path = ?,
  updated_at = NOW()
WHERE id = ?
```

#### 后端转换逻辑

```typescript
// 启用状态转换
const statusValue = enabled ? 1 : 0

// 动态构建更新字段
let updateFields = 'role_name=?, role_code=?, description=?, enabled=?'
const updateParams = [roleName, roleCode, description, statusValue]

// 如果提供了 dashboardPath，则更新
if (dashboardPath !== undefined) {
  updateFields += ', dashboard_path=?'
  updateParams.push(dashboardPath)
}

updateFields += ', updated_at=NOW()'
```

---

### 2.4 字段值转换规则

#### 启用状态转换

| 前端显示 | 前端表单 | API传输 | 后端处理 | 数据库存储 | 查询返回 |
| -------- | -------- | ------- | -------- | ---------- | -------- |
| "启用"   | true     | true    | 转换→1   | 1          | true     |
| "禁用"   | false    | false   | 转换→0   | 0          | false    |

**转换代码**：

```typescript
// 创建/更新时：前端 → 数据库
const status = enabled ? 1 : 0

// 查询时：数据库 → 前端
enabled: r.enabled === 1
```

#### 控制台路径说明

| 角色编码 | 默认路径                | 说明             |
| -------- | ----------------------- | ---------------- |
| R_SUPER  | /user/dashboard/console | 超级管理员控制台 |
| R_ADMIN  | /user/dashboard/console | 管理员控制台     |
| R_USER   | /user/dashboard/console | 普通用户控制台   |

**注意事项**：

- 创建角色时，如果未提供 `dashboardPath`，默认为 `'/user/dashboard/console'`
- 更新角色时，`dashboardPath` 为可选参数，如果不提供则不更新该字段
- 前端可以根据业务需求自定义不同角色的控制台路径

---

## 三、通用转换规则

### 3.1 日期时间转换

#### 数据库 → 后端 → 前端

```typescript
// 数据库存储格式（MySQL DATETIME）
DATETIME: '2025-11-16 21:36:50'

// SQL查询别名映射
created_at as createTime
updated_at as updateTime

// 后端返回（自动转为ISO 8601格式，UTC时间）
{
  createTime: '2025-11-16T13:36:50.000Z',  // UTC时间，比北京时间早8小时
  updateTime: '2025-11-16T13:36:50.000Z'
}

// 前端显示转换（使用全局日期工具）
import { formatDateTime } from '@/utils/date'

// 在表格列中应用
{
  prop: 'createTime',
  label: '创建日期',
  sortable: true,
  formatter: (row) => formatDateTime(row.createTime)
}
// 显示结果：'2025-11-16 21:36:50'（自动转为本地时间）
```

#### 全局日期格式化工具

**工具文件**：`src/utils/date.ts`

**主要功能**：

1. **formatDateTime(date, format?)**
   - 将ISO 8601格式转换为指定格式的本地时间
   - 支持字符串、Date对象、时间戳
   - 默认格式：`YYYY-MM-DD HH:mm:ss`

2. **formatDate(date)**
   - 仅显示日期部分：`YYYY-MM-DD`

3. **formatTime(date)**
   - 仅显示时间部分：`HH:mm:ss`

4. **getRelativeTime(date)**
   - 相对时间描述：“刚刚”、“5分钟前”等

**使用示例**：

```typescript
import { formatDateTime, formatDate, DateFormat } from '@/utils/date'

// 基本使用
formatDateTime('2025-11-16T13:36:50.000Z')
// => '2025-11-16 21:36:50'

// 自定义格式
formatDateTime('2025-11-16T13:36:50.000Z', DateFormat.Date)
// => '2025-11-16'

formatDate('2025-11-16T13:36:50.000Z')
// => '2025-11-16'

// 中文格式
formatDateTime('2025-11-16T13:36:50.000Z', DateFormat.DateTimeCN)
// => '2025年11月16日 21:36:50'
```

**日期格式枚举**：

```typescript
enum DateFormat {
  DateTime = 'YYYY-MM-DD HH:mm:ss', // 日期时间
  Date = 'YYYY-MM-DD', // 仅日期
  Time = 'HH:mm:ss', // 仅时间
  DateTimeShort = 'YYYY-MM-DD HH:mm', // 日期时间（短）
  DateTimeCN = 'YYYY年MM月DD日 HH:mm:ss', // 中文日期时间
  DateCN = 'YYYY年MM月DD日' // 中文日期
}
```

**注意事项**：

1. **时区问题**：
   - 数据库存储：本地时间（北京时间 GMT+8）
   - MySQL返回：ISO 8601 UTC时间（比北京时间早8小时）
   - 前端显示：自动转换为浏览器本地时间

2. **统一使用**：
   - 所有表格中的日期时间字段均使用 `formatDateTime`
   - 保证项目中日期时间显示格式的一致性

3. **已应用页面**：
   - ✅ 用户管理：`src/views/system/user/index.vue`
   - ✅ 角色管理：`src/views/system/role/index.vue`

#### 前端 → 后端 → 数据库

```typescript
// 前端不需要传递时间字段
// 后端自动使用 NOW() 生成当前时间

// SQL插入/更新
created_at = NOW()
updated_at = NOW()
```

---

### 3.2 命名转换规则

#### snake_case ↔ camelCase

| 数据库（snake_case） | 后端API（camelCase） | 说明       |
| -------------------- | -------------------- | ---------- |
| user_name            | userName             | 用户名     |
| real_name            | realName             | 真实姓名   |
| user_gender          | userGender           | 性别       |
| user_phone           | userPhone            | 手机号     |
| user_email           | userEmail            | 邮箱       |
| user_roles           | userRoles            | 角色列表   |
| role_name            | roleName             | 角色名称   |
| role_code            | roleCode             | 角色编码   |
| dashboard_path       | dashboardPath        | 控制台路径 |
| created_at           | createTime           | 创建时间   |
| updated_at           | updateTime           | 更新时间   |
| create_by            | createBy             | 创建人     |
| update_by            | updateBy             | 更新人     |

**转换方式**：

- 数据库→后端：SQL查询时使用 `AS` 别名
- 后端→数据库：手动映射字段名

```sql
-- 示例
SELECT
  user_name as userName,
  created_at as createTime
FROM users
```

---

### 3.3 类型转换规则汇总

| 前端类型          | API类型  | 数据库类型 | 转换方向 | 转换规则                       |
| ----------------- | -------- | ---------- | -------- | ------------------------------ |
| string            | string   | VARCHAR    | 双向     | 无需转换                       |
| number            | number   | INT        | 双向     | 无需转换                       |
| boolean           | boolean  | TINYINT    | 前→后→库 | true→1, false→0                |
| boolean           | boolean  | TINYINT    | 库→后→前 | 1→true, 0→false                |
| string("男"/"女") | string   | TINYINT    | 前→后→库 | "男"→1, "女"→2                 |
| string("1"/"2")   | string   | TINYINT    | 库→后→前 | 1→"1", 2→"2"                   |
| string[]          | string[] | INT        | 前→后→库 | 查询roles表，role_code→role_id |
| string[]          | string   | VARCHAR    | 库→后→前 | JOIN查询，转为数组             |
| string            | string   | DATETIME   | 库→后→前 | ISO 8601格式                   |
| -                 | -        | DATETIME   | 前→后→库 | 使用NOW()                      |

---

## 四、数据库迁移记录

### 4.1 用户表迁移

#### 迁移时间

2025-11-16

#### 迁移内容

1. **字段重命名**：
   - `mobile` → `phone`（已完成）
   - `sex` → `gender`（已完成）

2. **新增审计字段**：

   ```sql
   ALTER TABLE users
   ADD COLUMN create_by INT COMMENT '创建人ID' AFTER status,
   ADD COLUMN update_by INT COMMENT '更新人ID' AFTER create_by;
   ```

3. **数据迁移**：

   ```sql
   -- 迁移手机号
   UPDATE users SET phone = mobile WHERE mobile IS NOT NULL;

   -- 迁移性别
   UPDATE users SET gender = sex WHERE sex IS NOT NULL;

   -- 删除旧字段
   ALTER TABLE users DROP COLUMN mobile, DROP COLUMN sex;
   ```

#### 影响范围

- ✅ 后端控制器已更新
- ✅ 前端类型定义已更新
- ✅ 前端组件已更新

---

### 4.2 角色表迁移

#### 迁移时间

2025-11-16

#### 迁移内容

1. **字段重命名**：
   - `status` → `enabled`（已完成）

2. **数据迁移脚本**：

   ```sql
   -- 添加新字段
   ALTER TABLE roles
   ADD COLUMN enabled TINYINT DEFAULT 1
   COMMENT '启用状态：1-启用，0-禁用'
   AFTER description;

   -- 数据迁移
   UPDATE roles SET enabled = status WHERE status IS NOT NULL;

   -- 删除旧字段
   ALTER TABLE roles DROP COLUMN status;
   ```

3. **迁移结果**：
   ```
   ✅ 数据库迁移完成！
   ✓ 迁移 3 行数据
   ```

#### 影响范围

- ✅ 后端控制器已更新（使用enabled字段）
- ✅ 前端类型定义已更新
- ✅ 前端组件已更新

---

## 五、快速查询索引

### 5.1 按字段名查找

| 字段关键词 | 所属模块 | 数据库字段 | 后端字段 | 前端字段 | 章节链接 |
| --- | --- | --- | --- | --- | --- |
| 用户名 | 用户管理 | username | userName | userName | [1.1](#11-用户列表查询) |
| 手机号 | 用户管理 | mobile | userPhone | phone | [1.2](#12-用户创建) |
| 性别 | 用户管理 | sex | userGender | gender | [1.4](#14-字段值转换规则) |
| 角色 | 用户管理 | role_id | userRoles | role | [1.2](#12-用户创建) |
| 启用状态（用户） | 用户管理 | status | status | - | [1.1](#11-用户列表查询) |
| 角色名称 | 角色管理 | role_name | roleName | roleName | [2.1](#21-角色列表查询) |
| 角色编码 | 角色管理 | role_code | roleCode | roleCode | [2.1](#21-角色列表查询) |
| 启用状态（角色） | 角色管理 | enabled | enabled | enabled | [2.4](#24-字段值转换规则) |
| 控制台路径 | 角色管理 | dashboard_path | dashboardPath | dashboardPath | [2.2](#22-角色创建) |
| 创建时间 | 通用 | created_at | createTime | createTime | [3.1](#31-日期时间转换) |
| 更新时间 | 通用 | updated_at | updateTime | updateTime | [3.1](#31-日期时间转换) |

---

### 5.2 按转换类型查找

| 转换类型              | 涉及字段                | 所属模块 | 章节链接                  |
| --------------------- | ----------------------- | -------- | ------------------------- |
| 字段名映射            | mobile↔phone           | 用户管理 | [1.2](#12-用户创建)       |
| 字段名映射            | sex↔gender             | 用户管理 | [1.2](#12-用户创建)       |
| 字段名映射            | status↔enabled         | 角色管理 | [2.1](#21-角色列表查询)   |
| 值转换（字符串→数字） | "男"→1, "女"→2          | 用户管理 | [1.4](#14-字段值转换规则) |
| 值转换（布尔→数字）   | true→1, false→0         | 角色管理 | [2.4](#24-字段值转换规则) |
| 值转换（数字→布尔）   | 1→true, 0→false         | 角色管理 | [2.4](#24-字段值转换规则) |
| 关联查询转换          | role_code→role_id       | 用户管理 | [1.4](#14-字段值转换规则) |
| 数组转换              | string→string[]         | 用户管理 | [1.1](#11-用户列表查询)   |
| 日期时间转换          | DATETIME→string         | 通用     | [3.1](#31-日期时间转换)   |
| 自动填充              | JWT→create_by/update_by | 用户管理 | [1.4](#14-字段值转换规则) |

---

## 📌 维护说明

### 更新规则

当新增或修改字段映射时，请按以下步骤更新本文档：

1. **新增模块**：在文档末尾添加新章节，遵循现有结构
2. **修改映射**：更新对应的映射表，并在数据库迁移记录中添加说明
3. **新增转换规则**：在通用转换规则中补充新的转换类型
4. **更新索引**：在快速查询索引中添加新字段的索引项

### 文档版本管理

- 每次重大更新时，更新文档版本号
- 在数据库迁移记录中记录迁移时间和内容
- 保留历史迁移记录，便于问题追溯

---

## 📞 联系方式

如有疑问或建议，请联系：

- **文档维护者**：开发团队
- **最后更新时间**：2024-11-16

---

**文档结束**

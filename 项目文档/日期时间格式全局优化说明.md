# 日期时间格式全局优化说明

## 一、优化背景

### 问题描述

在前端页面中，表格的创建日期列显示的是ISO 8601格式的UTC时间，例如：

```
2025-11-16T13:36:50.000Z
```

但数据库中实际存储的是本地时间（北京时间 GMT+8）：

```
2025-11-16 21:36:50
```

### 期望效果

前端应该显示与数据库一致的本地时间格式：

```
2025-11-16 21:36:50
```

### 根本原因

- **数据库存储**：MySQL DATETIME 类型存储本地时间 `2025-11-16 21:36:50`
- **MySQL返回**：自动转换为ISO 8601格式的UTC时间 `2025-11-16T13:36:50.000Z`（比北京时间早8小时）
- **前端显示**：直接显示ISO格式字符串，用户体验差

---

## 二、解决方案

### 2.1 创建全局日期格式化工具

**文件位置**：`src/utils/date.ts`

**核心功能**：

```typescript
import { useDateFormat } from '@vueuse/core'

/**
 * 格式化日期时间
 * 将ISO 8601格式转换为指定格式的本地时间字符串
 */
export function formatDateTime(
  date: string | number | Date | null | undefined,
  format: string = DateFormat.DateTime
): string {
  if (!date) return '-'

  try {
    const dateObj = new Date(date)
    if (isNaN(dateObj.getTime())) return '-'

    // 使用 VueUse 的 useDateFormat 进行格式化
    // 会自动将UTC时间转换为浏览器本地时间
    return useDateFormat(dateObj, format).value
  } catch (error) {
    console.error('日期格式化错误:', error)
    return '-'
  }
}
```

**日期格式枚举**：

```typescript
export enum DateFormat {
  DateTime = 'YYYY-MM-DD HH:mm:ss', // 日期时间
  Date = 'YYYY-MM-DD', // 仅日期
  Time = 'HH:mm:ss', // 仅时间
  DateTimeShort = 'YYYY-MM-DD HH:mm', // 日期时间（短）
  DateTimeCN = 'YYYY年MM月DD日 HH:mm:ss', // 中文日期时间
  DateCN = 'YYYY年MM月DD日' // 中文日期
}
```

**辅助函数**：

- `formatDate(date)` - 仅格式化日期部分
- `formatTime(date)` - 仅格式化时间部分
- `isToday(date)` - 判断是否为今天
- `getRelativeTime(date)` - 获取相对时间（如"5分钟前"）

---

### 2.2 统一导出

**文件位置**：`src/utils/index.ts`

```typescript
// 日期时间相关
export * from './date'
```

这样可以通过 `@/utils` 直接导入：

```typescript
import { formatDateTime, DateFormat } from '@/utils'
```

---

### 2.3 应用到表格列

#### 用户管理页面

**文件位置**：`src/views/system/user/index.vue`

**修改内容**：

```typescript
// 1. 导入日期工具
import { formatDateTime } from '@/utils/date'

// 2. 在表格列定义中应用
{
  prop: 'createTime',
  label: '创建日期',
  sortable: true,
  formatter: (row) => formatDateTime(row.createTime)
}
```

#### 角色管理页面

**文件位置**：`src/views/system/role/index.vue`

**修改内容**：

```typescript
// 1. 导入日期工具
import { formatDateTime } from '@/utils/date'

// 2. 在表格列定义中应用
{
  prop: 'createTime',
  label: '创建日期',
  width: 180,
  sortable: true,
  formatter: (row) => formatDateTime(row.createTime)
}
```

---

## 三、时区转换说明

### 3.1 数据流转过程

```
数据库 (MySQL)
  ↓
  DATETIME: '2025-11-16 21:36:50' (本地时间 GMT+8)
  ↓
MySQL JSON 序列化
  ↓
  ISO 8601: '2025-11-16T13:36:50.000Z' (UTC时间)
  ↓
后端 Node.js
  ↓
  返回给前端: '2025-11-16T13:36:50.000Z'
  ↓
前端 JavaScript
  ↓
  new Date('2025-11-16T13:36:50.000Z')
  ↓
  自动转换为浏览器本地时间
  ↓
useDateFormat 格式化
  ↓
  显示: '2025-11-16 21:36:50' (本地时间 GMT+8)
```

### 3.2 关键点

1. **MySQL返回UTC时间**
   - DATETIME字段在JSON序列化时会被转换为ISO 8601格式
   - 自动转换为UTC时间（比北京时间早8小时）

2. **JavaScript自动处理时区**
   - `new Date('2025-11-16T13:36:50.000Z')` 会自动转换为浏览器本地时区
   - 在中国用户的浏览器中会自动加8小时

3. **useDateFormat格式化**
   - VueUse的useDateFormat使用浏览器本地时间
   - 格式化后显示的是本地时间

---

## 四、使用示例

### 4.1 基本使用

```typescript
import { formatDateTime } from '@/utils/date'

// 将ISO 8601格式转换为本地时间
formatDateTime('2025-11-16T13:36:50.000Z')
// => '2025-11-16 21:36:50'
```

### 4.2 自定义格式

```typescript
import { formatDateTime, DateFormat } from '@/utils/date'

// 仅显示日期
formatDateTime('2025-11-16T13:36:50.000Z', DateFormat.Date)
// => '2025-11-16'

// 仅显示时间
formatDateTime('2025-11-16T13:36:50.000Z', DateFormat.Time)
// => '21:36:50'

// 短格式
formatDateTime('2025-11-16T13:36:50.000Z', DateFormat.DateTimeShort)
// => '2025-11-16 21:36'

// 中文格式
formatDateTime('2025-11-16T13:36:50.000Z', DateFormat.DateTimeCN)
// => '2025年11月16日 21:36:50'
```

### 4.3 表格列中使用

```typescript
{
  prop: 'createTime',
  label: '创建日期',
  sortable: true,
  formatter: (row) => formatDateTime(row.createTime)
}

// 自定义格式
{
  prop: 'createTime',
  label: '创建日期',
  formatter: (row) => formatDateTime(row.createTime, DateFormat.DateTimeShort)
}
```

### 4.4 相对时间

```typescript
import { getRelativeTime } from '@/utils/date'

getRelativeTime(new Date(Date.now() - 60000))
// => '1分钟前'

getRelativeTime(new Date(Date.now() - 3600000))
// => '1小时前'

getRelativeTime(new Date(Date.now() - 86400000 * 3))
// => '3天前'

// 超过7天显示具体日期
getRelativeTime(new Date(Date.now() - 86400000 * 10))
// => '2025-11-06'
```

---

## 五、技术要点

### 5.1 VueUse集成

项目已经安装了 `@vueuse/core`，直接使用其中的 `useDateFormat` 函数：

```typescript
import { useDateFormat } from '@vueuse/core'

const formatted = useDateFormat(new Date(), 'YYYY-MM-DD HH:mm:ss')
console.log(formatted.value) // => '2025-11-16 21:36:50'
```

**优势**：

- 响应式的日期格式化
- 自动处理时区转换
- 支持多种日期格式模式
- 轻量级、无额外依赖

### 5.2 类型安全

所有函数都有完整的TypeScript类型定义：

```typescript
function formatDateTime(date: string | number | Date | null | undefined, format?: string): string

enum DateFormat {
  DateTime = 'YYYY-MM-DD HH:mm:ss',
  Date = 'YYYY-MM-DD'
  // ...
}
```

### 5.3 错误处理

- 输入为空时返回 `'-'`
- 无效日期时返回 `'-'`
- 格式化错误时返回 `'-'` 并输出错误日志

---

## 六、测试验证

### 6.1 手动测试步骤

1. **启动前端服务**

   ```bash
   npm run dev
   ```

2. **访问用户管理页面**

   ```
   http://localhost:3007/#/system/user
   ```

3. **检查创建日期列**
   - 应显示格式：`2025-11-16 21:36:50`
   - 不应显示：`2025-11-16T13:36:50.000Z`

4. **访问角色管理页面**

   ```
   http://localhost:3007/#/system/role
   ```

5. **检查创建日期列**
   - 应显示格式：`2025-11-16 21:36:50`
   - 不应显示：`2025-11-16T13:36:50.000Z`

### 6.2 验证要点

- ✅ 日期时间格式正确：`YYYY-MM-DD HH:mm:ss`
- ✅ 时区转换正确：显示本地时间（北京时间）
- ✅ 空值处理正确：显示 `-`
- ✅ 排序功能正常

---

## 七、已应用页面

| 页面     | 文件路径                          | 日期字段   | 状态      |
| -------- | --------------------------------- | ---------- | --------- |
| 用户管理 | `src/views/system/user/index.vue` | createTime | ✅ 已应用 |
| 角色管理 | `src/views/system/role/index.vue` | createTime | ✅ 已应用 |

---

## 八、后续优化建议

### 8.1 其他页面应用

如果项目中还有其他页面使用日期时间字段，可以按照同样的方式应用：

```typescript
// 1. 导入工具
import { formatDateTime } from '@/utils/date'

// 2. 在列定义中使用
{
  prop: 'createTime',
  label: '创建时间',
  formatter: (row) => formatDateTime(row.createTime)
}
```

### 8.2 表单日期选择器

如果表单中需要日期时间选择器，Element Plus 的 DatePicker 组件已支持 `valueFormat` 属性：

```vue
<ElDatePicker
  v-model="form.datetime"
  type="datetime"
  placeholder="选择日期时间"
  value-format="YYYY-MM-DD HH:mm:ss"
/>
```

### 8.3 日期范围筛选

搜索栏中的日期范围筛选也可以使用统一格式：

```vue
<ElDatePicker
  v-model="searchForm.daterange"
  type="datetimerange"
  range-separator="至"
  start-placeholder="开始日期"
  end-placeholder="结束日期"
  value-format="YYYY-MM-DD HH:mm:ss"
/>
```

---

## 九、相关文档

- [VueUse useDateFormat](https://vueuse.org/core/useDateFormat/)
- [Element Plus DatePicker](https://element-plus.org/zh-CN/component/date-picker.html)
- [字段映射与转换规则](./字段映射与转换规则.md#31-日期时间转换)
- [用户管理功能优化说明](./用户管理功能优化说明.md)

---

## 十、总结

通过创建全局日期格式化工具，实现了以下目标：

✅ **统一格式**：所有日期时间字段使用统一的 `YYYY-MM-DD HH:mm:ss` 格式✅ **时区转换**：自动将UTC时间转换为浏览器本地时间✅ **类型安全**：完整的TypeScript类型定义✅ **易于使用**：简单的API，一行代码即可应用✅ **可扩展性**：支持多种日期格式和相对时间显示✅ **全局应用**：通过统一导出，任何页面都可以使用

这是一个全局性的优化，确保了项目中所有日期时间显示的一致性和用户体验。
